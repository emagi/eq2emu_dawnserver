<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="/css/style.css" rel="stylesheet" type="text/css">
</head>
<body>
  <h2>Welcome, <%= username %>!</h2>
  <% server_status = "unavailable" %>
  <% if (server_loaded == 1 && login_status === 'online' && world_status === 'online' && worldlogin_connected === 'connected') {
	server_status = "available"
  } %>
  <% ls_status = "unavailable" %>
  <% if (login_status === 'online') {
	ls_status = "available"
  } %>
  <% ws_status = "unavailable" %>
  <% if (world_status === 'online') {
	ws_status = "available"
  } %>
  <h3 id="serverStatusHeader" class="<%= server_status %>"></h3>
  <p>Your role: <%= role %></p>
   <% if (role == 'admin') { %>
	<p><a href="/register">Create New Users</a></p>
   <% } %>
  <table>
  <tr>
        <th>Server Type</th>
        <th>Status</th>
        <th>Uptime</th>
        <th>World->Login Connected</th>
        <th>Commands</th>
        <th>PID</th>
  </tr>
  <tr>
  <td>Login Server</td>
  <td id="statusLogin" class="<%= ls_status %>"><%= login_status %></td>
  <td id="statusLoginUptime">
  <% if (login_uptime !== '') { %>
	<%= login_uptime %>
  <% } %>
  </td>
  <td>N/A</td>
  <td>
  <% if (role == 'admin') { %>
	<form action="/view_login_log">
		<input type="submit" value="View Login Server Log" />
	</form>
  <% } %>
  <% if (login_pid == "-1" && role == 'admin' && (login_status === 'Unknown' || login_status === 'offline')) { %>
	<form action="/start_login">
		<input type="submit" value="Start Login Server" />
	</form>
  <% }
	 else if (login_pid != "-1" && role == 'admin') { %>
	<form action="/stop_login">
		<input type="submit" value="Stop Login Server" />
	</form>
	<% } %>
  </td>
  <td id="statusLoginPID"><%= login_pid %></td>
  </tr>
  
  
  <tr>
  <td>World Server</td>
  <td id="statusWorld" class="<%= ws_status %>"><%= world_status %></td>
  <td id="statusWorldUptime">
  <% if (world_uptime !== '') { %>
	<%= world_uptime %>
  <% } %>
  </td>
  <% wl_status = "unavailable" %>
  <% if (worldlogin_connected === 'connected') {
	wl_status = "available"
  } %>
  <td id="statusWorldLoginConnected" class="<%= wl_status %>"><%= worldlogin_connected %></td>
  <td>
  <% if (role == 'admin') { %>
	<form action="/view_world_log">
		<input type="submit" value="View World Server Log" />
	</form>
  <% } %>
  <% if (world_pid == "-1" && role == 'admin' && (world_status === 'Unknown' || world_status === 'offline')) { %>
	<form action="/start_world">
		<input type="submit" value="Start World Server" />
	</form>
  <% }
	 else if (world_pid != "-1" && role == 'admin') { %>
	<form action="/stop_world">
		<input type="submit" value="Stop World Server" />
	</form>
	<form action="/world_clients">
		<input type="submit" value="List World Clients" />
	</form>
	<% } %>
  </td>
  <td id="statusWorldPID"><%= world_pid %></td>
  </tr>
  </table>

  <a href="/">Logout</a>
  
  
    <script>
        // Function to fetch updates from the server
        async function fetchUpdates() {
            try {
                const response = await fetch('/dashboard_update');
                const data = await response.json();
                
                // Update the DOM with the fetched data
				var message = "Unknown Status";
				if(data.server_loaded == 0) {
						message = "Server is starting up, please wait!";
				   } else if(data.ls_status === 'unavailable' || data.ws_status === 'unavailable') {
						message = "Database and configuration loaded, login and/or world not yet online";
				} else if(data.worldlogin_connected !== 'connected') {
						message = "World is not connected to login server!";
				} else {
						message = "Server Running!";
				}
                document.getElementById('serverStatusHeader').innerText = message;
				document.getElementById('statusWorldPID').innerText = data.world_pid;
				document.getElementById('statusWorld').innerText = data.world_status;
				document.getElementById('statusWorldUptime').innerText = data.world_uptime;
				document.getElementById('statusWorldLoginConnected').innerText = data.worldlogin_connected;
				
				document.getElementById('statusLoginPID').innerText = data.login_pid;
				document.getElementById('statusLogin').innerText = data.login_status;
				document.getElementById('statusLoginUptime').innerText = data.login_uptime;
            } catch (error) {
                console.error('Error fetching updates:', error);
            }
        }
		
		fetchUpdates();
        // Polling function to fetch updates every 5 seconds
        setInterval(fetchUpdates, 5000);
    </script>
</body>
</html>
